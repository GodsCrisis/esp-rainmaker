name: Build ESP32-H2 PlantWatering RainMaker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # Aggressive disk space cleanup to prevent build failures
      - name: Free up disk space
        run: |
          echo "=== Before cleanup ==="
          df -h
          sudo rm -rf /usr/share/dotnet \
                /usr/local/lib/android \
                /opt/ghc \
                /usr/local/share/boost \
                /usr/local/lib/node_modules \
                /opt/hostedtoolcache \
                "$AGENT_TOOLSDIRECTORY"
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' '^php.*' \
              azure-cli google-chrome-stable firefox powershell mono-devel \
              2>/dev/null || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          docker system prune -af || true
          echo "=== After cleanup ==="
          df -h
          
      # Checkout your repository containing PlantWatering project
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      # Initialize submodules for your repository
      - name: Ensure submodules are initialized
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive --depth 1
      
      # Install required system packages
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0 \
            git-lfs pkg-config libglib2.0-dev libpixman-1-dev libgcrypt20-dev
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      # Disable cache compression to save disk space
      - name: Disable cache compression to save disk space
        run: |
          echo "ACTIONS_CACHE_COMPRESSION_LEVEL=0" >> $GITHUB_ENV
          
      # Cache ESP-IDF tools to speed up builds
      - name: Cache ESP-IDF tools
        uses: actions/cache@v4
        with:
          path: ~/.espressif
          key: esp-idf-tools-${{ runner.os }}-v5.4.1
          
      # Install ESP-IDF v5.4.1 for ESP32-H2
      - name: Install ESP-IDF v5.4.1
        run: |
          mkdir -p ~/esp
          cd ~/esp
          echo "Cloning ESP-IDF v5.4.1..."
          git clone --recursive --shallow-submodules --branch v5.4.1 --depth 1 https://github.com/espressif/esp-idf.git
          cd esp-idf
          echo "Installing ESP-IDF tools for ESP32-H2..."
          ./install.sh esp32h2
          echo "ESP-IDF installation complete"
          rm -rf .git
          df -h
      
      # Build the firmware
      - name: Build Firmware
        run: |
          set +e
          
          echo "Activating ESP-IDF environment..."
          source ~/esp/esp-idf/export.sh

          export IDF_TARGET=esp32h2
          export PROJECT_DIR=$GITHUB_WORKSPACE/examples/PlantWatering
          
          echo "Using IDF_TARGET=$IDF_TARGET"
          echo "Building project at: $PROJECT_DIR"
          
          cd "$PROJECT_DIR"
          
          echo "Project structure:"
          ls -la
          echo "Main directory:"
          ls -la main/
          
          echo "=== Disk space before build ==="
          df -h

          idf.py set-target esp32h2
          idf.py fullclean
          idf.py build
          build_status=$?

          echo "==== BUILD STATUS CODE: $build_status ===="

          echo "=== Disk space after build ==="
          df -h

          if [ $build_status -ne 0 ]; then
            echo "==== BUILD FAILED, SHOWING LAST 100 LINES OF LOG ===="
            tail -n 100 build/log/idf_py_stderr_output_* || true
            tail -n 50 build/log/idf_py_stdout_output_* || true
            exit $build_status
          fi
          
      # Locate firmware binaries
      - name: Debug locate firmware binaries
        run: |
          echo "Current directory: $(pwd)"
          find . -type f \( -name "*.bin" -o -name "*.elf" \) | sort
          
      # Prepare flash instructions file
      - name: Prepare firmware info file
        run: |
          mkdir -p examples/PlantWatering/build

          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          cat > examples/PlantWatering/build/FLASH_INSTRUCTIONS.txt << EOF
          ESP32-H2 PlantWatering RainMaker Controller - Flash Instructions
          ==================================================================

          Build Information:
          ------------------
          Build Date: ${BUILD_DATE}
          Commit: ${{ github.sha }}
          Target: ESP32-H2
          Framework: ESP RainMaker

          FLASH COMMANDS:
          ===============

          Method 1 - Using idf.py:
          cd examples/PlantWatering
          idf.py -p /dev/ttyUSB0 flash monitor

          Method 2 - Using esptool.py:
          esptool.py -p /dev/ttyUSB0 -b 460800 --chip esp32h2 write_flash 0x0 bootloader.bin 0x8000 partition-table.bin 0x20000 PlantWatering.bin

          Method 3 - Using ESP Launchpad (Web):
          1. Visit https://espressif.github.io/esp-launchpad/
          2. Connect ESP32-H2 via USB
          3. Upload binaries at offsets:
             - 0x0: bootloader.bin
             - 0x8000: partition-table.bin
             - 0x20000: PlantWatering.bin

          BINARIES INCLUDED:
          ==================
          - bootloader.bin (offset 0x0)
          - partition-table.bin (offset 0x8000)
          - PlantWatering.bin (offset 0x20000)
          - PlantWatering.elf (debug symbols)

          SETUP:
          ======
          1. Flash firmware using method above
          2. Download ESP RainMaker app (iOS/Android)
          3. Add device and follow provisioning
          4. Control GPIO10 output via app

          GPIO10 Output Control:
          - Power: ON/OFF switch
          - Brightness: 0-100% (0V to 3.3V via PWM)
          - PWM: 1kHz, 10-bit resolution

          Troubleshooting:
          ----------------
          - Flash fails: Try lower baud rate -b 115200
          - Device not found: Check Thread network
          - Monitor output: idf.py -p /dev/ttyUSB0 monitor
          EOF
          
      # List build outputs for verification
      - name: Debug build output
        run: |
          echo "Listing build outputs..."
          find examples/PlantWatering/build -type f \( -name "*.bin" -o -name "*.elf" \) | sort
          
      # Upload firmware artifacts
      - name: Prepare and upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PlantWatering_firmware
          path: |
            examples/PlantWatering/build/*.bin
            examples/PlantWatering/build/bootloader/*.bin
            examples/PlantWatering/build/partition_table/*.bin
            examples/PlantWatering/build/*.elf
            examples/PlantWatering/build/*.map
            examples/PlantWatering/build/FLASH_INSTRUCTIONS.txt
            
      # Create build summary
      - name: Build summary
        if: always()
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "## Build Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Project Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Target:** ESP32-H2" >> $GITHUB_STEP_SUMMARY
            echo "- **Project:** PlantWatering GPIO10 Controller" >> $GITHUB_STEP_SUMMARY
            echo "- **Framework:** ESP RainMaker" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Build Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Features" >> $GITHUB_STEP_SUMMARY
            echo "- GPIO10 PWM voltage output" >> $GITHUB_STEP_SUMMARY
            echo "- ON/OFF control via RainMaker app" >> $GITHUB_STEP_SUMMARY
            echo "- Brightness 0-100% (0V-3.3V)" >> $GITHUB_STEP_SUMMARY
            echo "- PWM: 1kHz, 10-bit resolution" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Download" >> $GITHUB_STEP_SUMMARY
            echo "Firmware available in **Artifacts** section" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Quick Flash" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "cd examples/PlantWatering" >> $GITHUB_STEP_SUMMARY
            echo "idf.py -p /dev/ttyUSB0 flash monitor" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Build Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check build logs above for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Disk Space" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          df -h >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
